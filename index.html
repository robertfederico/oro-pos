<!-- 
   2. Use Javascript to bind navigation keys (arrow keys)
   3. autocomplete search for item name (just hardcode item arrays in dropdown)
   4. Pressing ENTER once, will allow edit of field
   5. Pressing ESC once when editing field will remove editing capabilities for that field.
   6. Pressing ESC when not in edit field mode, will initiate a popup saying if you want to cancel this transaction. 
   if proceed, then the screen data clears all fields.
   7. Pressing ENTER when not in edit field mode, will initate a popup saying if you want to finalize this transaction. 
   if proceed, then the screen data clears all fields.
   6. Disable alt-f4 
-->

<!-- 
   !TODO
   pressing enter will open a modal : label: Customers Cash

 -->

<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8" />
      <meta http-equiv="X-UA-Compatible" content="IE=edge" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>Document</title>
      <link
         href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css"
         rel="stylesheet"
         integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1"
         crossorigin="anonymous"
      />
      <link
         href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
         rel="stylesheet"
      />

      <style>
         table tbody tr {
            height: 2rem;
         }
         .select2-container--default .select2-selection--single {
            height: 100% !important;
         }
      </style>
   </head>
   <body>
      <div class="container p-5">
         <div class="row">
            <div class="col-md-8">
               <div class="row">
                  <div class="col-md-12 mb-5">
                     <div class="row">
                        <div class="col-md-6 row">
                           <div class="col-4">
                              <label for="barcode" class="">Invoice #:</label>
                           </div>
                           <div class="col-8">
                              <input
                                 type="text"
                                 id="barcode"
                                 class="form-control input-controls"
                              />
                           </div>
                        </div>
                        <div class="col-md-6">
                           <select
                              class="js-example-basic-single form-select h-100 input-controls"
                              name="products"
                              id="products"
                           >
                              <option value="0">Select Item</option>
                           </select>
                        </div>
                     </div>
                  </div>
                  <div class="col-md-12">
                     <table class="table table-bordered h-100" id="orders">
                        <thead>
                           <tr>
                              <th scope="col">#</th>
                              <th scope="col">Item Description</th>
                              <th scope="col">Quantity</th>
                              <th scope="col">Price</th>
                           </tr>
                        </thead>
                        <tbody></tbody>
                     </table>
                  </div>
               </div>
            </div>
            <div class="col-md-4">
               <div class="card h-100">
                  <div
                     class="card-body d-flex flex-column justify-content-between"
                  >
                     <div
                        class="d-flex justify-content-between align-items-center"
                     >
                        <h2>Grand Total :</h2>
                        <h3>P250.00</h3>
                     </div>
                     <div>
                        <div
                           class="d-flex justify-content-between align-items-center"
                        >
                           <h5>Cash :</h5>
                           <p>P500.00</p>
                        </div>
                        <div
                           class="d-flex justify-content-between align-items-center"
                        >
                           <h5>Change :</h5>
                           <p>P250.00</p>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
         </div>

         <div
            class="modal fade"
            id="exampleModal"
            data-bs-backdrop="static"
            tabindex="-1"
         >
            <div class="modal-dialog">
               <div class="modal-content">
                  <form>
                     <div class="modal-header">
                        <h5 class="modal-title">Customers Cash</h5>
                        <button
                           type="button"
                           class="btn-close"
                           data-bs-dismiss="modal"
                           aria-label="Close"
                        ></button>
                     </div>
                     <div class="modal-body">
                        <input type="text" class="form-control" id="cash" />
                     </div>
                     <div class="modal-footer">
                        <button
                           type="button"
                           class="btn btn-secondary"
                           data-bs-dismiss="modal"
                        >
                           Close
                        </button>
                        <button type="submit" class="btn btn-primary">
                           Save
                        </button>
                     </div>
                  </form>
               </div>
            </div>
         </div>
      </div>
      <script
         src="https://code.jquery.com/jquery-3.5.1.min.js"
         integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
         crossorigin="anonymous"
      ></script>
      <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
      <script
         src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
         integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"
         crossorigin="anonymous"
      ></script>

      <script>
         $(document).ready(function () {
            let input = document.getElementById('barcode')
            let products = document.getElementById('products')
            let ordersTable = document.getElementById('orders')
            let tableItems = 0
            let cashModal = document.getElementById('exampleModal')
            let editEnter = false
            let proceed = false

            let escKey = false
            let editMode = false

            let data = [
               {
                  id: 0,
                  text: 'Nescafe Classic',
               },
               {
                  id: 1,
                  text: 'Nescafe Classic',
               },
               {
                  id: 2,
                  text: 'Nescafe Blend and Brew',
               },
               {
                  id: 3,
                  text: 'Great Taste White',
               },
               {
                  id: 4,
                  text: 'Kopiko Black',
               },
               {
                  id: 5,
                  text: 'Kopiko Brown',
               },
               {
                  id: 6,
                  text: 'Summit Drinking Water',
               },
            ]

            $('.js-example-basic-single').select2({
               data: data,
            })

            $(document).on(
               'focus',
               '.select2-selection.select2-selection--single',
               function (e) {
                  $(this)
                     .closest('.select2-container')
                     .siblings('select:enabled')
                     .select2('open')
               }
            )

            $('select.js-example-basic-single').on(
               'js-example-basic-single:closing',
               function (e) {
                  $(e.target)
                     .data('select2')
                     .$selection.one('focus focusin', function (e) {
                        e.stopPropagation()
                     })
               }
            )

            document.addEventListener('keydown', function (event) {
               if (event.key == 'Escape') {
                  if (escKey) {
                     input.disabled = true
                     input.value = ''
                  }

                  if (!editMode) {
                     if (tableItems !== 0) {
                        if (confirm('Cancel this transaction?')) {
                           tableItems = 0

                           var rowCount = ordersTable.rows.length
                           for (var x = rowCount - 1; x > 0; x--) {
                              ordersTable.deleteRow(x)
                           }
                        }
                     }
                  }
               }
               if (event.key == 'Enter') {
                  if (editEnter) {
                     input.disabled = false
                  }
                  if (tableItems > 0) {
                     proceed = true
                     var myModal = new bootstrap.Modal(cashModal)
                     myModal.show()
                  }
               }
            })

            input.addEventListener('focus', function () {
               escKey = true
               editMode = true
               editEnter = true
            })

            input.addEventListener('focusout', function () {
               escKey = false
               editMode = false
            })

            document.addEventListener('keydown', handleInputFocusTransfer)

            function handleInputFocusTransfer(e) {
               // This method move focus to next item input on DOWN or to previous item input on UP arrow key press.
               const focusableInputElements = document.querySelectorAll(
                  `.input-controls`
               )

               //Creating an array from the node list
               const focusable = [...focusableInputElements]

               //get the index of current item
               const index = focusable.indexOf(document.activeElement)

               // Create a variable to store the idex of next item to be focussed
               let nextIndex = 0

               if (e.keyCode === 39) {
                  e.preventDefault()
                  nextIndex = index + 1 < focusable.length ? index + 1 : index
                  focusableInputElements[nextIndex].focus()
               } else if (e.keyCode === 37) {
                  // left arrow
                  e.preventDefault()
                  nextIndex = index + 1 < focusable.length ? index + 1 : index
                  focusableInputElements[nextIndex].focus()
               }
            }

            var xhr
            $('#products').on('change', function () {
               tableItems++
               console.log($(this).val())
               if (xhr) {
                  xhr.abort()
               }
               // $('#orders').html('')
               xhr = $.getJSON('products.json', function (data) {
                  $.each(data, function (i, obj) {
                     if (obj.id == $('#products').val()) {
                        $('#orders').append(
                           `<tr> 
                           <td> ${i} </td>
                           <td> ${obj.text} </td> 
                           <td> 1 </td> 
                           <td> ${obj.price}.00 </td> 
                        </tr>`
                        )
                     }
                  })
               }).always(function () {
                  xhr = undefined
               })
            })
         })
      </script>
   </body>
</html>
